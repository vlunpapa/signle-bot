# DexScreener 数据获取说明

## 📊 当前实现的数据获取方式

### API端点
- **端点**：`https://api.dexscreener.com/latest/dex/tokens/{token}`
- **返回**：当前时刻的交易对数据（**不是历史K线**）

### 数据特点

**每次API调用只返回1个数据点**：

| 请求的周期 | 返回的数据点数量 | 说明 |
|-----------|----------------|------|
| `["1m"]` | **1根** 1分钟K线 | 当前时刻的1分钟数据 |
| `["5m"]` | **1根** 5分钟K线 | 当前时刻的5分钟数据 |
| `["15m"]` | **1根** 15分钟K线 | 当前时刻的15分钟数据 |
| `["1m", "5m", "15m"]` | **3根** K线 | 分别是1m、5m、15m各1根 |

### 重要说明

⚠️ **DexScreener的 `/tokens/{token}` API不提供历史K线数据**

- 每次调用返回的是**当前时刻的快照数据**
- 不是真正的"历史1分钟K线"或"历史5分钟K线"
- 如果需要历史数据，需要通过**连续监测**来积累

## 🔄 如何获取多根K线数据

### 方法1：连续监测（已实现）

**工作原理**：
1. 每分钟调用一次API，获取当前时刻的数据
2. 将每次获取的数据作为"1分钟K线"存储
3. 积累到足够数量后，执行策略分析

**示例**：
```python
# 第1分钟：获取数据点1（当前时刻）
# 第2分钟：获取数据点2（当前时刻）
# 第3分钟：获取数据点3（当前时刻）
# ...
# 第10分钟：获取数据点10（当前时刻）
# 结果：10根"1分钟K线"数据（实际上是10个时间点的快照）
```

**优点**：
- ✅ 可以积累足够的数据进行策略分析
- ✅ 实时监测，数据新鲜

**缺点**：
- ⚠️ 不是真正的"历史K线"（OHLC可能不准确）
- ⚠️ 需要等待时间积累数据

### 方法2：使用历史K线API（如果DexScreener提供）

**需要检查**：
- DexScreener是否有 `/candles` 或 `/klines` 端点
- 是否支持通过 `pairAddress` 获取历史K线

**如果存在，可以这样实现**：
```python
# 获取历史K线
url = f"https://api.dexscreener.com/v1/pairs/{pair_address}/candles?interval=1m&limit=10"
# 返回：10根真正的1分钟K线数据
```

## 📝 当前代码实现

### 数据获取流程

```python
# 1. 请求多个周期
intervals = ["1m", "5m", "15m"]

# 2. 调用API（只返回当前时刻数据）
pair_data = await get_dexscreener_data(token)

# 3. 为每个周期生成1根K线
for interval in intervals:
    kline = convert_to_kline(pair_data, interval)
    # 结果：每个interval只有1根K线
```

### 返回结果示例

```python
# 请求：intervals=["1m", "5m", "15m"]
# 返回：
[
    StandardKlineData(interval="1m", timestamp=now, ...),  # 1根
    StandardKlineData(interval="5m", timestamp=now, ...),  # 1根
    StandardKlineData(interval="15m", timestamp=now, ...)  # 1根
]
# 总共：3根K线，但都是"当前时刻"的数据
```

## 🎯 策略执行的影响

### "外源性爆发二段告警"策略

**需求**：至少4根连续的1分钟K线数据

**解决方案**：
1. ✅ 启动连续监测（10分钟）
2. ✅ 每分钟获取一次数据
3. ✅ 积累到4根时，执行策略分析
4. ✅ 继续监测直到10分钟，持续检查

### "5分钟交易量告警"策略

**需求**：1根5分钟K线数据

**解决方案**：
- ✅ 直接获取即可（1次API调用）
- ✅ 不需要连续监测

## 💡 总结

**你的理解完全正确**：
- 选择 `["1m"]` → 返回 **1根** 1分钟K线
- 选择 `["5m"]` → 返回 **1根** 5分钟K线
- 选择 `["1m", "5m"]` → 返回 **2根** K线（1m和5m各1根）

**关键点**：
- DexScreener API不提供历史K线
- 每次调用只返回当前时刻的数据
- 需要多根数据时，必须通过连续监测积累
